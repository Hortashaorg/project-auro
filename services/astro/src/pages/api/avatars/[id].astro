---
import { throwError } from "@package/common";
import { initDatabase } from "@src/logic/db/database";
import { Navbar } from "@src/sections/Navbar";
import Avatars from "./index.astro";

const db = await initDatabase();

const assetId = Astro.params.id ?? throwError("No asset id found");
const account = Astro.locals.account ?? throwError("No account found");

await db
  .updateTable("account")
  .where("id", "=", account.id)
  .set({
    avatarAssetId: assetId,
  })
  .executeTakeFirstOrThrow();

const avatarUrl = await db
  .selectFrom("asset")
  .where("id", "=", assetId)
  .selectAll()
  .executeTakeFirstOrThrow();

export const partial = true;
---

<Avatars />

<div id="navbar" hx-swap-oob="true">
  <Navbar client:only="true" loggedIn={true} avatarUrl={avatarUrl.url} />
</div>
