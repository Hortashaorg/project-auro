---
import { throwError } from "@package/common";
import { getDB } from "@package/database";
import Servers from "./index.astro";

const db = await getDB();
const serverId = Astro.params.id ?? throwError("No server id found");
const account = Astro.locals.account ?? throwError("No account found");

let user = await db
	.selectFrom("user")
	.where((eb) =>
		eb.and([eb("accountId", "=", account.id), eb("serverId", "=", serverId)]),
	)
	.selectAll()
	.executeTakeFirst();

if (!user) {
	user = await db
		.insertInto("user")
		.values({
			accountId: account.id,
			serverId: serverId,
		})
		.returningAll()
		.executeTakeFirstOrThrow();
}

await db
	.updateTable("account")
	.set({
		currentServerId: serverId,
	})
	.where("id", "=", account.id)
	.executeTakeFirstOrThrow();
---
<Servers />